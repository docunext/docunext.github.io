
DSpam is a [[spam]] / junk control defense I've been interested in for awhile. I'm working on setting it up on a couple of our servers, and when I get around to it, I'll add my notes here.

#### My Experience with DSpam
I've been a long time user of [[spamassassin]], but I've wanted to use DSpam for awhile. I'd heard its bayesian classification system was superior.

On [[Debian]], it was easy to setup, but it turned out to be a very challenging customization process. After wrestling with it for about 24 hours, I'm a little weary, but hopeful about using it in the future. At least I learned a lot about [[Postfix]] in the process!

Some of the glitches I encountered:
* I couldn't get the [[SQLite]] driver to work
* I couldn't get it to use large-scale home directory formatting
* The grouping method doesn't work with the hash driver
* I found the virtual user mechanisms are very difficult compared to those found in [[Dovecot]] and [[Postfix]]

Some of the things I was impressed by:
* Fast
* Great web interface - [[DSpam Webfrontend]]
* Seems to work best as a relay - in the end I'm going with a check_client_access filter at the end of my smtpd_recipient_restrictions list. Its an [[LMTP]] connection to the DSpam socket, which in turn connects via [[SMTP]] to [[Postfix]] which uses [[Dovecot]]'s deliver to save the message to the user's maildir. Actually, its possible to simply have DSpam call [[Dovecot]]'s deliver as its TrustedDeliveryAgent.

Some of the things I need to work on:
* Retraining - web interface makes this possible, and there is a [[Dovecot]] plugin to fix this too
* Filtering - I don't think I'll use the quarantine method, but instead use a [[Seive]] filter to put the [[spam]] into a spam folder (the email address I'm using is dc9c95@adjkerntz.com, hint hint)

### DSpam Installation
I'm using [[debian]] so installation is a breeze:
<pre>
apt-get install libdspam7 dspam libdspam7-drv-sqlite3
</pre>
I'm surprised that it also installed [[clamav]]. Is that required or recommended?
<pre>
clamav clamav-base clamav-daemon clamav-freshclam dspam dspam-doc libclamav5 libdspam7 libdspam7-drv-sqlite3 procmail
</pre>

### DSpam Configuration
I'm reading through /etc/dspam/dspam.conf, and it appears that dspam is sort of like [[spamassassin]] in that it can filter messages based upon a set of criteria. It also appears that it is an [[smtp]] proxy like [[spampd]]. It can also quarantine email, that's nice.

### Second Attempt to install DSpam on [[Debian]]
<pre>
apt-get install dspam dspam-webfrontend libdspam7-drv-sqlite3 dovecot-antispam
vim /etc/default/dspam
# Variables for dspam.
#
# Do not start dspam.
START=yes

# User that runs dspam.
USER=dspam

# Options for dspam.
#OPTIONS="--debug"
</pre>
I also edited /etc/dspam.conf and changed ServerPort to 10124.

#### DSPam Headers
<pre>
X-DSPAM-Result: Innocent
X-DSPAM-Processed: Fri Aug 28 23:24:22 2009
X-DSPAM-Confidence: 1.0000
X-DSPAM-Probability: 0.0023
X-DSPAM-Signature: 4a986726183232121316661
</pre>

#### DSpam Compile Time Options
I'm surprised that DSpam uses compile-time options to select things like domain scale and large scale. I'm also surprised that [[Debian]] has chosen to use domain scale.

### DSpam Optimizations
I'm now using a server socket for dspam:
<pre>
ServerDomainSocketPath  "/var/spool/postfix/var/run/dspam/dspam.sock"
</pre>
This example is on [[Debian]], so I setup the socket in the [[Postfix]] chroot.

<pre>
mkdir /var/spool/postfix/var/run/dspam
chmod 0775 /var/spool/postfix/var/run/dspam/
chgrp dspam /var/spool/postfix/var/run/dspam
adduser postfix dspam
</pre>

#### Dspam Groups
<pre>
echo "global@adjkerntz.com:merged:*" >> /var/spool/dspam/group
chown dspam:dspam /var/spool/dspam/group
</pre>

### DSPAM Errors
#### Need LHLO here
It took me awhile to figure out this one:
<pre>Need LHLO here</pre>
In master.conf, I had smtp instead of lmtp:
<pre>
dspam   unix  -       -       n       -       1       lmtp
    -o smtp_send_xforward_command=yes
</pre>

### See Also
* [[DSpam Webfrontend]]

###  Links
* http://www.mirrors.docunext.com/cgit.cgi/dspam/
* http://apps.sourceforge.net/mediawiki/dspam-community/index.php?title=Main_Page
* http://dspamwiki.expass.de/Installation/Maildrop
* http://www.wains.be/pub/postfix/dspam-webui-debian.txt
* https://help.ubuntu.com/community/Postfix/Dspam

