pfSense is similar to [[m0n0wall]] but has a different underbelly and thus a much different set of features and functions. Also, it uses the [[FreeBSD]] PF packet filter, and the ALTQ traffic management system

I'm planning to try out some more tests with this setup soon. Right now I'm just setting up two pfSense machines so that I can test out carp failover as well.

#### pfSense Load Balancer
The pfSense load balancer is nice in that it is simple - you add the servers you want to balance across, and you are pretty much done. However, I've run into some issues with it:

* too many firewall states
* incorrect "down status" from time to time
* can't figure out how and if the server down ip to be on another network

Granted, these issues are the result of my own limited knowledge of how slbd works, so hopefully I can work them out.

Additional load balancing topics:
* [[pfSense Carp]]

#### pfSense [[DNS]] Settings

For pfSense [[DNS]], I set the two addresses on the General page to our two private [[unbound]] servers which are on external public ip addresses. Then I set the [[DHCP]] server to use the private [[LAN]] address as the first [[DNS]] entry, and the first unbound server as the second. I think this is a good setup for our networks.

#### [[NFS]] and [[MTU]]
This isn't specific to pfSense, but since I use pfSense, it rears its ugly head. I'm not exactly sure, but I think it has to do with IP fragments. I use [[FIOS]] which, like [[PPP]], uses a [[WAN]] [[MTU]] of 1492. [[IPSec]] also adds to IP overhead, reducing the data capacity of each packet. pfSense docs suggest but do not confirm that [[NFS]] on [[GNU/Linux]] sends fragmented packets that also have the do not fragment bit on the packet header. Confusing? Yes. Ultimately, I do stuff like this:




And this in my [[Fstab]]:

<pre class="sh_sh">
192.0.2.1:/ /mnt/point nfs4    _netdev,noauto,noatime,rsize=512,wsize=512,user 0 0
</pre>

#### Namespace Collisions
I keep getting a warning about a namespace collision in the default ruleset. I have no idea what this is about - just started happening recently...

### [[TSIG]] [[DNS]] Updates

I had to change /etc/inc/services.inc for version 1.2.x:

<pre class="sh_php">
			/* generate update instructions */
			$upinst =  "server update.dyndns.com\n";
			$upinst .= "zone intra.savonix.com\n";
			$upinst .= "key {$config['dnsupdate']['keyname']} {$config['dnsupdate']['keydata']}\n";
			$upinst .= "update add {$config['dnsupdate']['host']} {$config['dnsupdate']['ttl']} A {$wanip}\n";
			$upinst .= "send\n";
			$upinst .= "\n";	/* mind that trailing newline! */
</pre>

And this for version 2.x (see [http://redmine.pfsense.org/projects/pfsense/repository/revisions/master/entry/etc/inc/services.inc services.inc]):
<pre class="sh_php">
			$upinst .= "zone intra.savonix.com\n";
			$upinst .= "key {$dnsupdate['keyname']} {$dnsupdate['keydata']}\n";
			$upinst .= "update add {$dnsupdate['host']} {$dnsupdate['ttl']} A {$wanip}\n";
			$upinst .= "send\n";
			$upinst .= "\n";	/* mind that trailing newline! */

				$fd = fopen("{$g['varetc_path']}/nsupdatecmds{$i}", "w");
				fwrite($fd, $upinst);
				fclose($fd);

				/* invoke nsupdate */
				$cmd = "/usr/bin/nsupdate -k {$g['varetc_path']}/K{$i}{$keyname}+157+00000.key";
</pre>

Ideally the form should also have the server address for updates and a zone selector, see:

https://www.dyndns.com/support/kb/ddns_updates_and_tsig.html

#### pfsense 2
#### VPN
I'm having a tough time getting [[IPSec]] to work in pfSense 2.0 when one peer has a dynamic IP address. I'm either getting:

<pre class="sh_log">
racoon: [vpn-granite]: ERROR: exchange Aggressive not allowed in any applicable rmconf.
</pre>

or

<pre class="sh_log">
ERROR: exchange Identity Protection not allowed in any applicable rmconf.
</pre>

AHA! I guess I'll have to use a dynamic [[DNS]] entry for the gateway to the peer that has a dynamic ip address. Indeed, that works fine. No mobile client is needed. To setup the dynamic [[DNS]], I am using TSIG with both pfSense 1.2 and 2.0.

In this case, do I need to set pre-shared keys on the "Pre-Shared Keys" tab? '''No''' - as of 20101002, I was able to setup an [[IPSec]] tunnel using a FQDN as the identifier and didn't need anything under the "Pre-Shared Keys" tab on either endpoint. I believe that is only for mobile clients. In my experience, [[OpenVPN]] is easier for mobile clients.

#### Firewall and NAT

Lots of great updates to the [[firewall]] and [[NAT]] capabilities of pfSense. I like that they now support "'''sloppy state'''"! Not sure what it means yet, but it sounds entertaining!







#### pfSense 1.3 traffic shaper overview



#### What is a limiter?




#### Multi-Wan
The multi-wan feature is truly amazing. It might be a little bit confusing to those who are unfamiliar with intermediate networking concepts, but for those who are, it might be very impressive - it is to me at least!

#### Tunnels
The tunneling capabilities of pfSense 2.0 are amazing. I've never used a [[GIF Tunnel]] but I have used a [[GRE Tunnel]] and it worked perfectly for what I needed.




#### Traffic Shaper

Actually, now that I've figured out what's going on with the new pfSense traffic shaper, it doesn't seem to need much work! It is way more integrated with the firewall, which makes perfect sense. Using firewall rules, I can essentially make classifiers which, aside being blocked, passed, or redirected to a lan destination via [[NAT]], can also be shaped using different queuing disciplines and dummy limiter interfaces.

#### [[IPSec]] Pages

I keep getting this error:
"Warning: openssl_x509_read(): supplied parameter cannot be coerced into an X509 certificate! in /etc/inc/vpn.inc on line 219 Warning: stristr(): Empty delimiter in /etc/inc/vpn.inc on line 831 Warning: Cannot modify header information - headers already sent by (output started at /etc/inc/vpn.inc:219) in /usr/local/www/vpn_ipsec.php on line 101 "
