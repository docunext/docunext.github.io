### Preparation
NOTICE: These are just my notes, NOT instructions for setting this up on a production system!

http://cvs.apache.org/snapshots/httpd/
or
http://svn.apache.org/repos/asf/httpd/httpd/trunk/

<pre>
apt-get install autoconf libtool libmysqlclient15-dev
wget http://cvs.apache.org/snapshots/httpd/httpd_20070929221801.tar.gz
tar -xzvf httpd_20070929221801.tar.gz
cd httpd
svn co http://svn.apache.org/repos/asf/apr/apr/trunk srclib/apr
svn co http://svn.apache.org/repos/asf/apr/apr-util/trunk srclib/apr-util
./buildconf
./configure --enable-modules=most --enable-mpm=worker --with-included-apr --with-mysql=/usr --enable-dbd --enable-suexec --enable-rewrite
</pre>

You'll probably want your own configure settings.

Then I ran "make" and "make install".

After that, I was committed to getting mod_dbd and mod_rewrite to work. I did get it to work, but with a lot of issues.

### Configuration
Here's my config for what its worth:

<pre>
DBDriver mysql
DBDParams host=127.0.0.1,user=noway!,pass=youwish!,dbname=foobar_forevah
DBDMin  1
DBDKeep 2
DBDMax  10
DBDExptime 60
DBDPersist On
DBDPrepareSQL "select destination from rewrite where source = %s"

RewriteEngine On
#RewriteLog "/usr/local/apache2/logs/rewrite.log"
#RewriteLogLevel 3

RewriteMap myquery "dbd:select destination from rewrite where source = %s"
#RewriteMap myquery txt:blah.txt

RewriteCond %{REQUEST_URI} (.*)
#RewriteCond ${myquery:%1|nomatch} !nomatch
RewriteRule (.*) ${myquery:$1}
#RewriteRule /blog/(.*) /index.html
</pre>

### Problems with mod_rewrite and mod_dbd
Strange behaviors:
* I couldn't use RewriteLog ad a dbd powered rewrite map for some strange reason. Server just wouldn't start.
* Adding the DBDPrepareSQL was the only way I could get the %s parameter to work, but I was '''incredibly pleased''' once it finally worked.
* The only key that worked for me was $1. If I used %1 or %{REWRITE_MAP}, it was a no go. Along those lines, RewriteCond wasn't happening with the dbd powered rewritemap.
* DefaultValues for the rewrite map would not work for me either.
* Also couldn't use a simple RewriteCond with %{REQUEST_FILENAME} !-f

Besides those issues, I'm glad I tried this out and test a few of the options. This is going to be a really major step forward for Apache when 2.3 is released. I can't wait! My guess is that it won't be for awhile, but I've got plenty to keep me busy in the meantime.

The problems I'm experiencing could be due to the fact that I'm running this on a unique kernel - its a low-latency kernel from ubuntu, patched with a custom DSDT and running on a debian base system. I restarted using a standard kernel and I'm still having these problems. Also tried prefork but that didn't make a difference. Also tried turning off MMap and Sendfile.

Just dawned on me that its possible that 2.3 is a developer's version, and isn't likely to work predictably. I would like to learn more about this so I'm going to try again with gdb. I just built 2.2 to check to see if that would work more predictably and of course it does.

### Errors==
Here's the errors I've been getting:
<pre>
Syntax error on line 117 of /usr/local/apache2/conf/httpd.conf:
RewriteMap: file for map myquery not found:s
</pre>
Odd, since it has "dbd:" in there, but its looking for a file.

'''Using gdb''':
<pre>
intel954-1:/usr/src/httpd# gdb /usr/local/apache2/bin/httpd
GNU gdb 6.6.90.20070912-debian
Copyright (C) 2007 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "i486-linux-gnu"...
Using host libthread_db library "/lib/i686/cmov/libthread_db.so.1".
(gdb) b ap_process_request
Breakpoint 1 at 0x80a5c22: file http_request.c, line 285.
(gdb) run -X -d /usr/local/apache2
Starting program: /usr/local/apache2/bin/httpd -X -d /usr/local/apache2
Failed to read a valid object file image from memory.
[Thread debugging using libthread_db enabled]
[New Thread 0xb7b7d6b0 (LWP 28658)]

Program received signal SIGSEGV, Segmentation fault.
[Switching to Thread 0xb7af26b0 (LWP 28720)]
0xb7b7c4db in strlen () from /lib/i686/cmov/libc.so.6
(gdb) n
Single stepping until exit from function strlen,
which has no line number information.

Program terminated with signal SIGSEGV, Segmentation fault.
The program no longer exists.
</pre>

If I switch off the RewriteMap directive:
<pre>
intel954-1:/usr/src/httpd# gdb /usr/local/apache2/bin/httpd
GNU gdb 6.6.90.20070912-debian
Copyright (C) 2007 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "i486-linux-gnu"...
Using host libthread_db library "/lib/i686/cmov/libthread_db.so.1".
(gdb) b ap_process_request
Breakpoint 1 at 0x80a5c22: file http_request.c, line 285.
(gdb) run -X -d /usr/local/apache2
Starting program: /usr/local/apache2/bin/httpd -X -d /usr/local/apache2
Failed to read a valid object file image from memory.
[Thread debugging using libthread_db enabled]
[New Thread 0xb7ad66b0 (LWP 28693)]
[Switching to Thread 0xb7ad66b0 (LWP 28693)]
</pre>

#### Bad EIP Value
I just checked the console and saw that it reported a bad eip value. Ugh.
<pre>
BUG: unable to handle kernel paging request at virtual address 637808a1
 printing eip:
637808a1
*pde = 00000000
Oops: 0000 [#2]
SMP
Modules linked in: button ac battery cpufreq_userspace cpufreq_ondemand cpufreq_powersave
cpufreq_conservative cpufreq_stats freq_table ipv6 firewire_sbp2 loop snd_usb_audio
snd_usb_lib snd_seq_dummy snd_seq_oss snd_seq_midi snd_seq_midi_event snd_seq rtc
serio_raw parport_pc pcspkr snd_hda_intel psmouse snd_rawmidi snd_seq_device parport
snd_pcm_oss snd_mixer_oss snd_pcm snd_timer i2c_i801 i2c_core snd_hwdep iTCO_wdt snd
snd_page_alloc soundcore intel_agp heci agpgart evdev ext3 jbd mbcache dm_mirror
dm_snapshot dm_mod ide_generic sd_mod pata_marvell ata_piix ata_generic libata scsi_mod
firewire_ohci firewire_core crc_itu_t generic ide_core ehci_hcd uhci_hcd usbcore e1000
thermal processor fan
CPU:    0
EIP:    0060:[<637808a1>]    Not tainted VLI
EFLAGS: 00010286   (2.6.22-1-686 #1)
EIP is at 0x637808a1
eax: 00000286   ebx: 449a8727   ecx: 00000286   edx: 00000200
esi: c9044e79   edi: 31398a36   ebp: 8f5b9da5   esp: f50bbf28
ds: 007b   es: 007b   fs: 00d8  gs: 0033  ss: 0068
Process httpd (pid: 28672, ti=f50ba000 task=f7e49030 task.ti=f50ba000)
Stack: 8361d04f 310728c6 da33ff88 0fa222b2 0fab5ce0 359c5194 0f2465e6 d5b5d462
       f70f29fc 8ab77ef5 4fddbcaa f78bf775 3987c421 69fac467 0f00adc1 7e23342f
       123ae1a6 ff18e204 12027e85 a610a83a d8bca891 80c381e5 427f8a12 6836f2cb
Call Trace:

Code:  Bad EIP value.
EIP: [<637808a1>] 0x637808a1 SS:ESP 0068:f50bbf28
</pre>
Could it be bad memory?

#### Miscellaneous Errors
<pre>
[Mon Oct 01 17:38:26 2007] [notice] SIGHUP received.  Attempting to restart
[Mon Oct 01 17:38:26 2007] [notice] seg fault or similar nasty error detected in the parent process
</pre>

Now it works, but what did I do to make it work?
<pre>
[Mon Oct 01 17:40:10 2007] [error] [client 192.168.0.173] no authorization providers configured
[Mon Oct 01 17:40:10 2007] [error] [client 192.168.0.173] File does not exist: /usr/local/apache2/htdocs/bloggy
</pre>
(The rewrite rule is just rewriting /blog/ to /bloggy, neither exists.)

Without changing '''anything''' in the conf file, if I stop the server then try to start it again, it won't start, only reports this in the error log:
<pre>
[Mon Oct 01 17:40:10 2007] [error] [client 192.168.0.173] no authorization providers configured
[Mon Oct 01 17:40:10 2007] [error] [client 192.168.0.173] File does not exist: /usr/local/apache2/htdocs/bloggy
[Mon Oct 01 17:41:58 2007] [info] removed PID file /usr/local/apache2/logs/httpd.pid (pid=3114)
[Mon Oct 01 17:41:58 2007] [notice] caught SIGTERM, shutting down
[Mon Oct 01 17:41:59 2007] [notice] suEXEC mechanism enabled (wrapper: /usr/local/apache2/bin/suexec)
</pre>

From syslog:
<pre>
Message from syslogd@intel954-1 at Tue Oct  2 09:45:10 2007 ...
intel954-1 kernel: [ 2547.653760] general protection fault: 0000 [#1]

Message from syslogd@intel954-1 at Tue Oct  2 09:45:10 2007 ...
intel954-1 kernel: [ 2547.653834] PREEMPT SMP

Message from syslogd@intel954-1 at Tue Oct  2 09:45:10 2007 ...
intel954-1 kernel: [ 2547.655660] CPU:    0

Message from syslogd@intel954-1 at Tue Oct  2 09:45:10 2007 ...
intel954-1 kernel: [ 2547.655661] EIP:    0060:[<cbfc5294>]    Not tainted VLI

Message from syslogd@intel954-1 at Tue Oct  2 09:45:10 2007 ...
intel954-1 kernel: [ 2547.655662] EFLAGS: 00010296   (2.6.20-15-lowlatency #2)

Message from syslogd@intel954-1 at Tue Oct  2 09:45:10 2007 ...
intel954-1 kernel: [ 2547.655812] EIP is at 0xcbfc5294

Message from syslogd@intel954-1 at Tue Oct  2 09:45:10 2007 ...
intel954-1 kernel: [ 2547.655861] eax: 00000000   ebx: c92b4cee   ecx: f79fa000   edx: 00000000

Message from syslogd@intel954-1 at Tue Oct  2 09:45:10 2007 ...
intel954-1 kernel: [ 2547.655919] esi: 75595723   edi: 364dcc3b   ebp: 9e22ec2a   esp: f79fbf28

Message from syslogd@intel954-1 at Tue Oct  2 09:45:10 2007 ...
intel954-1 kernel: [ 2547.655977] ds: 007b   es: 007b   ss: 0068

Message from syslogd@intel954-1 at Tue Oct  2 09:45:10 2007 ...
intel954-1 kernel: [ 2547.656029] Process httpd (pid: 4852, ti=f79fa000 task=df857ab0 task.ti=f79fa000)

Message from syslogd@intel954-1 at Tue Oct  2 09:45:10 2007 ...
intel954-1 kernel: [ 2547.656088] Stack: da507e75 a3c6a305 6125019a 79d45031 347995cb 2f5a49bf 16f26575 2ead1e26

Message from syslogd@intel954-1 at Tue Oct  2 09:45:10 2007 ...
intel954-1 kernel: [ 2547.656355]        c8ef84fc 5a240366 0d0a7c9b a5633c12 254e6b44 5f00ad3d 303a677a 9c48e0c2

Message from syslogd@intel954-1 at Tue Oct  2 09:45:10 2007 ...
intel954-1 kernel: [ 2547.656622]        f61aaeff 0d67a665 fb056208 6950097b 11565e9a 698dba6b 91d9a249 b4613147

Message from syslogd@intel954-1 at Tue Oct  2 09:45:10 2007 ...
intel954-1 kernel: [ 2547.656889] Call Trace:

Message from syslogd@intel954-1 at Tue Oct  2 09:45:10 2007 ...
intel954-1 kernel: [ 2547.657004]

Message from syslogd@intel954-1 at Tue Oct  2 09:45:10 2007 ...
intel954-1 kernel: [ 2547.657052] Code: f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 <f0> f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0

Message from syslogd@intel954-1 at Tue Oct  2 09:45:10 2007 ...
intel954-1 kernel: [ 2547.658524] EIP: [<cbfc5294>] 0xcbfc5294 SS:ESP 0068:f79fbf28
</pre>

Same thing in dmesg:
<pre>
[ 2547.653760] general protection fault: 0000 [#1]
[ 2547.653834] PREEMPT SMP
[ 2547.653922] Modules linked in: button ac battery cpufreq_userspace cpufreq_ondemand cpufreq_powersave cpufreq_conservative cpufreq_stats freq_table ipv6 af_packet sbp2 loop snd_hda_intel snd_hda_codec snd_pcm_oss snd_mixer_oss snd_pcm snd_timer snd serio_raw psmouse i2c_i801 iTCO_wdt parport_pc parport pcspkr i2c_core soundcore iTCO_vendor_support intel_agp agpgart snd_page_alloc tsdev eth1394 evdev ext3 jbd mbcache dm_mirror dm_snapshot dm_mod sd_mod ata_piix pata_marvell ata_generic libata scsi_mod ohci1394 ieee1394 generic ehci_hcd uhci_hcd usbcore e1000 thermal processor fan fbcon tileblit font bitblit softcursor vesafb capability commoncap
[ 2547.655660] CPU:    0
[ 2547.655661] EIP:    0060:[<cbfc5294>]    Not tainted VLI
[ 2547.655662] EFLAGS: 00010296   (2.6.20-15-lowlatency #2)
[ 2547.655812] EIP is at 0xcbfc5294
[ 2547.655861] eax: 00000000   ebx: c92b4cee   ecx: f79fa000   edx: 00000000
[ 2547.655919] esi: 75595723   edi: 364dcc3b   ebp: 9e22ec2a   esp: f79fbf28
[ 2547.655977] ds: 007b   es: 007b   ss: 0068
[ 2547.656029] Process httpd (pid: 4852, ti=f79fa000 task=df857ab0 task.ti=f79fa000)
[ 2547.656088] Stack: da507e75 a3c6a305 6125019a 79d45031 347995cb 2f5a49bf 16f26575 2ead1e26
[ 2547.656355]        c8ef84fc 5a240366 0d0a7c9b a5633c12 254e6b44 5f00ad3d 303a677a 9c48e0c2
[ 2547.656622]        f61aaeff 0d67a665 fb056208 6950097b 11565e9a 698dba6b 91d9a249 b4613147
[ 2547.656889] Call Trace:
[ 2547.657004]
[ 2547.657052] Code: f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 <f0> f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0 f0
[ 2547.658524] EIP: [<cbfc5294>] 0xcbfc5294 SS:ESP 0068:f79fbf28
[ 2547.658621]
</pre>

#### Finally, Reproducible Behavior
If I comment out the RewriteMap:
<pre>
#RewriteMap myquery "dbd:select destination from rewrite where source = %s"
</pre>

then the server starts. If I uncomment it and restart the server without stopping it, it usually works, but now it doesn't.

If I comment out the RewriteMap and the rules that reference it, it starts. Then I uncomment the RewriteMap, one RewriteCond, and a RewriteRule and it restarts with mod_rewrite querying mod_dbd. I've reproduced this behavior several times. These are the lines I comment and uncomment during the restarting process:
<pre>
RewriteMap myquery "dbd:select destination from rewrite where source = %s"
RewriteCond %{REQUEST_FILENAME} !-f
RewriteRule (.*) ${myquery:$1}
</pre>
I did this with a normal kernel, now to try the preemptive one, which I'm only using because its patched with a DSDT that has the ability to wake on lan.

So happy... it does indeed do this after a reboot with the other kernel. Cool. Now to delve into why this happens...

### Related Pages
* [[Apache]]
* [[MySQL]]

### External Links
* http://marc.info/?l=apache-modules&m=113719519409563&w=2
* http://httpd.apache.org/dev/debugging.html#gdb
* http://bahumbug.wordpress.com/2006/10/16/interesting-new-apache-features/

