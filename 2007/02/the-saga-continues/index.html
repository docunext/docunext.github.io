<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.742409eb857ab2ccca34.css" data-identity="gatsby-global-css">li{margin-right:1rem}h1,li{display:inline-block}h1{font-style:normal;margin-top:0}header{margin-bottom:1.5rem}header ul{float:right;list-style:none}#wrapper{margin:3em auto;max-width:700px;padding:10px}.blogPostDate{color:#333;font-size:8pt;margin-bottom:9px;padding-top:4px}</style><meta name="generator" content="Gatsby 4.4.0"/><title data-react-helmet="true">The Filesystem Saga Continues</title><link data-react-helmet="true" rel="canonical" href="https://www.docunext.com/2007/02/the-saga-continues/"/><link as="script" rel="preload" href="/webpack-runtime-910253975eed29c257e8.js"/><link as="script" rel="preload" href="/framework-e27ef662c918f795a5a3.js"/><link as="script" rel="preload" href="/app-578f356f1ad3d3b2b65e.js"/><link as="script" rel="preload" href="/commons-bbb2797d08d51fd1bd26.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-cc8ebf9459c2ce2cf980.js"/><link as="fetch" rel="preload" href="/page-data/2007/02/the-saga-continues/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/2191495970.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/4224293195.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div id="wrapper"><header><ul><li><a href="/about/">About</a></li></ul><a href="/"><h1>Docunext</h1></a></header><hr/><div><h2>The Filesystem Saga Continues</h2><div class="blogPostDate">February 19th, 2007</div><div><p>True, the saga continues. This is a great excuse to learn logical drive images inside and out. Now I'm trying to remove unused, non-partitioned space from a logical disk image that contains an MBR (master boot record), an 8GB NTFS partition, and almost 12GB of unused, non-partitioned space.</p>
<p>Here are the tools I've thought of using so far: * Mac's Disk Utility - though it doesn't understand NTFS very well* hdiutil - has a resize command but it won't work on disks with an mbr afaik* ntfsprogs - great program but I'm not sure how well it works with images* fdisk from linux - not sure how well it works with linux* qemu-img* dd</p>
<p>Right now I'm trying to "dd" the disk image I made with Disk Utility. It is 18.3GB, but the "disk" inside of it is only 7.5GB. That, I believe, is the ntfs partition. So I suspect that it will not have the master boot record on it. I'm guessing that is at the beginning the main disk image.</p>
<p><strong>Dealing with virtual devices</strong></p>
<p>In Mac OS X, devices are located in /dev/ and so when you have a disk image, you gotta wonder where the "device" is located. Its also in /dev/, but it has an "r" in front, so instead of:</p>
<pre>/dev/disk0</pre>
<p>you have:</p>
<pre>/dev/rdisk0</pre>
<p>The confusing thing is how these are created and destroyed. You can open an image in Disk Utility but it will mount the image. You can then unmount the image and the device remains. Note, if you eject the image, the device is destroyed.</p>
<p>This might look a little strange to be duplicating a partition to a device node, but I think it just might work. Here's the command I'm using:</p>
<pre>dd if=/dev/rdisk3s1 of=/dev/rdisk2</pre>
<p>However, what about the master boot record? I don't think that it is stored on the ntfs partition, and because /dev/rdisk3s1 is only 7.5GB, and /dev/rdisk3 is 18.3GB, I'm guessing that there is information on /dev/rdisk3 that is needed.</p>
<p>If I use this command:</p>
<pre>dd if=/dev/rdisk3 of=/dev/rdisk2 count=1 bs=512</pre>
<p>it might muck up the ntfs partition that I jut copied there. Hmmmm.</p>
<p><strong>Linux!</strong></p>
<p>I cancelled that, and am now trying to use ntfsresize and ntfsclone to move the ntfs partition and mbr to a new virtual disk using parallels, based upon the premise that parallels disk images are really just .cdr images. Within linux running in parallels, the disk image shows up as a real drive, and I mapped the original drive to parallels, so its easy to do a dd from the original partition to a new one I created on a virtual drive. Once that's done, I'm going to dd the mbr from the original disk to the second. Then once that is complete, I'll try to run the new drive directly in Parallels, or convert it to a qcow image and run it from Q.</p>
<p>So the coolest thing I learned today so far was from the dd manual page: if you kill the process with the following code you will get a status report of the progress:</p>
<pre>kill -USR1 $pid</pre>
<blockquote>
<pre>       Note that sending a SIGUSR1 signal to a running 'dd' process makes  it       print to standard error the number of records read and written so far,       then to resume copying.              $ dd if=/dev/zero of=/dev/null& pid=$!              $ kill -USR1 $pid; sleep 1; kill $pid              10899206+0 records in 10899206+0 records out</pre></blockquote>
<p><strong>The Finale</strong></p>
<p>Here's how it ended up going down: <ol><li>Used the thecus n21000 running debian as a usb2 host to dd the ntfs partition to a file. Did the same with the mbr. The speed averaged about 7MB/s.</li><li>Used netcat to send the ntfs file over to a Parallels virtual machine running debian which had a 8GB virtual drive image mounted; did the same with the mbr. Transfer rate of about 1.2 MB/s. </li></ol></p>
<p><strong>Related:</strong></p>
<p>Some interesting links I found while researching this topic:</p>
<p><a href="http://uneasysilence.com/archive/2007/01/9404/">How to Resize Your Parallels Drive, and Get Windows to Recognize It</a></p>
<p><a href="http://www.inference.phy.cam.ac.uk/saw27/notes/backup-hard-disk-partitions.html">Notes on backing up entire hard disks or partitions</a></p>
<p><a href="http://www.linuxquestions.org/questions/showthread.php?t=362506">Learn the dd command</a></p>
<p><a href="http://www.kidsquid.com/cgi-bin/moin.cgi/FrequentlyAskedQuestions#head-46d3f40c447a63bbd7c6f325f7c771a77cfa58f8">Convert .hdd to qcow</a></p>
<p><a href="http://en.wikipedia.org/wiki/Master_boot_record">Wikipedia Master Boot Record</a></p>
<p><a href="http://marc.abramowitz.info/archives/2007/02/17/getting-good-performance-out-of-usb-hard-drives-in-linux/">Linux USB hard drive performance</a></p></div></div><div><span>Yearly Indexes: </span><span><a href="/2003/"><span>2003</span></a> </span><span><a href="/2004/"><span>2004</span></a> </span><span><a href="/2006/"><span>2006</span></a> </span><span><a href="/2007/"><span>2007</span></a> </span><span><a href="/2008/"><span>2008</span></a> </span><span><a href="/2009/"><span>2009</span></a> </span><span><a href="/2010/"><span>2010</span></a> </span><span><a href="/2011/"><span>2011</span></a> </span><span><a href="/2012/"><span>2012</span></a> </span><span><a href="/2013/"><span>2013</span></a> </span><span><a href="/2015/"><span>2015</span></a> </span><span><a href="/2019/"><span>2019</span></a> </span><span><a href="/2020/"><span>2020</span></a> </span><span><a href="/2022/"><span>2022</span></a> </span></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/2007/02/the-saga-continues/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-9068a959998310636008.js"],"app":["/app-578f356f1ad3d3b2b65e.js"],"component---src-pages-about-js":["/component---src-pages-about-js-738961a9611f9aa4e8d4.js"],"component---src-pages-games-react-nuzaq-js":["/component---src-pages-games-react-nuzaq-js-50d5da494a82a1aaeb8b.js"],"component---src-pages-index-js":["/component---src-pages-index-js-3aa2421409c5653df938.js"],"component---src-pages-years-js":["/component---src-pages-years-js-d36f319c6c16ef9e8314.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-cc8ebf9459c2ce2cf980.js"],"component---src-templates-year-js":["/component---src-templates-year-js-e8af3ddab603f61c6142.js"]};/*]]>*/</script><script src="/polyfill-9068a959998310636008.js" nomodule=""></script><script src="/component---src-templates-blog-post-js-cc8ebf9459c2ce2cf980.js" async=""></script><script src="/commons-bbb2797d08d51fd1bd26.js" async=""></script><script src="/app-578f356f1ad3d3b2b65e.js" async=""></script><script src="/framework-e27ef662c918f795a5a3.js" async=""></script><script src="/webpack-runtime-910253975eed29c257e8.js" async=""></script></body></html>