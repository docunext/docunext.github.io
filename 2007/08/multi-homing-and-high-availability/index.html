<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.742409eb857ab2ccca34.css" data-identity="gatsby-global-css">li{margin-right:1rem}h1,li{display:inline-block}h1{font-style:normal;margin-top:0}header{margin-bottom:1.5rem}header ul{float:right;list-style:none}#wrapper{margin:3em auto;max-width:700px;padding:10px}.blogPostDate{color:#333;font-size:8pt;margin-bottom:9px;padding-top:4px}</style><meta name="generator" content="Gatsby 4.4.0"/><title data-react-helmet="true">Multi homing and high availability</title><link data-react-helmet="true" rel="canonical" href="https://www.docunext.com/2007/08/multi-homing-and-high-availability/"/><link as="script" rel="preload" href="/webpack-runtime-910253975eed29c257e8.js"/><link as="script" rel="preload" href="/framework-e27ef662c918f795a5a3.js"/><link as="script" rel="preload" href="/app-578f356f1ad3d3b2b65e.js"/><link as="script" rel="preload" href="/commons-bbb2797d08d51fd1bd26.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-cc8ebf9459c2ce2cf980.js"/><link as="fetch" rel="preload" href="/page-data/2007/08/multi-homing-and-high-availability/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/2191495970.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/4224293195.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div id="wrapper"><header><ul><li><a href="/about/">About</a></li></ul><a href="/"><h1>Docunext</h1></a></header><hr/><div><h2>Multi homing and high availability</h2><div class="blogPostDate">August 30th, 2007</div><div><p>Last night I worked on punbb a little - mainly to add support for hosting multiple sites with a single copy of the software. I was successful to a certain degree. I had to modify the cache folder layout o include a sub-directory for each forum instance, and those sub-folders have to be created manually. All in all, my changes were very minor and I'll likely create a diff for those who are interested in doing the same.</p>
<p>I've also been looking for a new way to manage virtual hosts. I prefer to keep my web server configuration focused on the network - ip addresses and what not, and leave the handling of domains and urls for scripts which can be updated on the fly without restarting the web server.</p>
<p>Beyond that, I've been exploring multi-homing. It is a quick and easy way to</p>
<p>acheive high-availability. As I understand it, you assign two different ip addresses to a single a record, and supporting clients will be able to try either one, and if one doesn't work, they'll use the other. This provides very basic "round-robin" load balancing as well, but the distribution is hit-or-miss.</p>
<p>Servers that can be relatively easily multi-homed include web servers and smtp servers. Web servers are a little more challenging because you have to keep the content in sync, but mysql's replication capabilities make that a lot easier. In the case of simple replication, all you have to do is make sure that only the primary server is updated, which is a simple task with a scripted if / then statement.</p>
<p>imap service would be a terrific service to multi-home, but it poses a well-known and difficult challenge: synchronized, distributed, fault-tolerant file systems. Trying to side step that challenge as referred to with a web server by only updating the master, you cannoteasily ensure that the primary file system is updated.</p>
<p>It might be possible to use something like DRDB to keep two file systems in syncronization, but in my experience you need a dedicated (100+ Mbit) network to make that happen. Given the size of most emails, it might be possible over a 1Mbit line.</p>
<p>An alternative technique would be to not use multi-homing but instead use a failover switch to a secondary and regularly syncronized backup. When the primary server fails, the imap dns entry would need to update to point towards the backup imap server, requiring a low ttl (300 seconds?) for practical use.</p>
<p>In this way, you can use the built-in backup mail transfer (mx) dns records to point to either multiple smtp server and the secondary and tertiary servers will hold the mail until the primary is back online.</p>
<p>xmmp and voip is another potential candidate for multihoming or high-availability failover.</p>
<p>techniques like drdb are better suited towards single location setups, to make sure that a service doesn't go down even when the service is up. along those lines, multi-homing and failovers should be the last step in the chain of failure - meaning that everything (within reason) that could have gone wrong would not have caused interruption, even if multi-homing were not in place.</p>
<p>For that to happen, you'd need to have a highly available filesystem, with RAID and DRDB, multiple, a load balancer, systems monitor, and load director, as well as have those be highly available. The problem with that setup is that for the majority of the time the setup is major overkill, and for 24/7 operations, the energy costs can get substantial. I've been conducting a bunch of research in this area and I think I've come up with some pretty good solutions.</p>
<p>My interests are are now focused on the pfSense distribution, and its implementation of CARP - or common address routing protocol, as well as its load balancing system. I've recently purchased two WRAP boards to configure this with, however they only have two ethernet ports each, so I might be looking at using a wireless card for having them monitor each other, which wouldn't be too big of a deal, unless they can monitor each other through the lan, but I've heard a danger in this setup is a "split brain" condition in which both routers are unable to connect to each other and are both trying to be the master.</p>
<p>Behind that setup, I plan to setup a cluster of:</p>
<ul>
<li>load-balanced, high-availability pxe-booted web, email, dns, and ntp servers</li>
<li>mysql ndb cluster</li>
<li>a highly available nfs drbd server used to provide the storage requirements for the above mentioned servers.</li>
</ul>
<p>Services that "will never go down" are still subject to the possibility of a regional network outage, and that is where the multihoming and failover takes place.</p>
<p>Another strategy I'm exploring is the idea of outgoing load-balancing. I'm still unsure how that fits into this plan. I'm not sure if that is part of the work I'm planning for with carp.</p>
<p>And yet another concept I've been exploring is that of virtualization. In some cases it might not make sense to put separate different services (like ntp and dns) on separate machines, but it might make sense to put them on separate virtual machines for process isolation and security purposes.</p>
<p>By doubling up on everything and setting up multi-homing or failovers, you protect yourself to a certain degree, but the failover servers "waiting for the primary server to fail" are a waste of energy. Futhermore, as service demands ebb and flow, the number of machines in a service pool does not need to remain constant. For these reasons, it makes sense to consider the use of different power levels in each of the machines.</p>
<p>For example, the following techniques can be employed to save energy, yet provide backup machines in the event of failure:</p>
<ul>
<li>cpu frequency and voltage scaling</li>
<li>hard disk standby</li>
<li>sleep states</li>
<li>powering off the machine</li>
</ul>
<p>The ability to control the power given to servers is a necessity, but not easily achieved. ACPI, sleep states, wake-on-lan, and switched power distributions can help.</p>
<p>Monitoring, logging, and remote controls.</p>
<p>¥</p></div></div><div><span>Yearly Indexes: </span><span><a href="/2003/"><span>2003</span></a> </span><span><a href="/2004/"><span>2004</span></a> </span><span><a href="/2006/"><span>2006</span></a> </span><span><a href="/2007/"><span>2007</span></a> </span><span><a href="/2008/"><span>2008</span></a> </span><span><a href="/2009/"><span>2009</span></a> </span><span><a href="/2010/"><span>2010</span></a> </span><span><a href="/2011/"><span>2011</span></a> </span><span><a href="/2012/"><span>2012</span></a> </span><span><a href="/2013/"><span>2013</span></a> </span><span><a href="/2015/"><span>2015</span></a> </span><span><a href="/2019/"><span>2019</span></a> </span><span><a href="/2020/"><span>2020</span></a> </span><span><a href="/2022/"><span>2022</span></a> </span></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/2007/08/multi-homing-and-high-availability/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-9068a959998310636008.js"],"app":["/app-578f356f1ad3d3b2b65e.js"],"component---src-pages-about-js":["/component---src-pages-about-js-738961a9611f9aa4e8d4.js"],"component---src-pages-games-react-nuzaq-js":["/component---src-pages-games-react-nuzaq-js-50d5da494a82a1aaeb8b.js"],"component---src-pages-index-js":["/component---src-pages-index-js-3aa2421409c5653df938.js"],"component---src-pages-years-js":["/component---src-pages-years-js-d36f319c6c16ef9e8314.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-cc8ebf9459c2ce2cf980.js"],"component---src-templates-year-js":["/component---src-templates-year-js-e8af3ddab603f61c6142.js"]};/*]]>*/</script><script src="/polyfill-9068a959998310636008.js" nomodule=""></script><script src="/component---src-templates-blog-post-js-cc8ebf9459c2ce2cf980.js" async=""></script><script src="/commons-bbb2797d08d51fd1bd26.js" async=""></script><script src="/app-578f356f1ad3d3b2b65e.js" async=""></script><script src="/framework-e27ef662c918f795a5a3.js" async=""></script><script src="/webpack-runtime-910253975eed29c257e8.js" async=""></script></body></html>