{"componentChunkName":"component---src-templates-blog-post-js","path":"/2010/06/flock/","result":{"data":{"site":{"siteMetadata":{"domain":"https://www.docunext.com"}},"markdownRemark":{"html":"<p>Myon wrote another blog post about cool unix features, this time about flock:</p>\n<p><a href=\"http://www.df7cb.de/blog/2010/flock.html\">Cool unix features: flock</a></p>\n<p>This is definitely of interest to me, as I've written some shell scripts recently which use a manual lock implementation which I'm not sure if it works as I'd intended.</p>\n<p>For example, here's a shell script I wrote to be run when incron notices a filesystem event in the /etc/bind/ folder:</p>\n<pre class=\"sh_sh\">\n#!/bin/sh\n# Copyright: Savonix Corporation - http://www.savonix.com/\n# Author:    Albert Lash\n# License:   MIT\n# Date:      20090602\nlockfile=\"/var/lock/rebuild_bind.lock\"\nif [ -f $lockfile ] ; then\n    exit 0\nelse\n    touch $lockfile\n    sleep 20\n    #/etc/init.d/bind9 restart\n    /usr/sbin/rndc reload\n    rm $lockfile\n    exit 0\nfi;\n</pre>\n<p>The man page mentions a third form of using flock, like this:</p>\n<pre class=\"sh_sh\">\n(\n         flock -s 200\n         # ... commands executed under lock ...\n       ) 200>/var/lock/mylockfile\n</pre>\n<p>That's the one I'll use. Actually, it took me a few minutes to figure this one... the lock wasn't working for me when I was trying a non-blocking, exclusive lock. I did some more search and found this helpful page:</p>\n<p><a href=\"http://jdimpson.livejournal.com/5685.html\">using flock to protect critical sections in shell scripts</a></p>\n<p>This is now what I'm using:</p>\n<pre class=\"sh_sh\">\n#!/bin/sh\n# Copyright: Savonix Corporation - http://www.savonix.com/\n# Author:    Albert Lash\n# License:   MIT\n# Date:      20090602\nexec 8>/var/lock/rebuild_bind.lock;\nif flock -n -x 8; then\n    /usr/sbin/rndc reload\n    sleep 30;\nfi\n</pre>\n<p>The reason why I'm using sleep? My incron setup occasionally results in many triggers getting fired, and I only want one to result in the rebuilding of the bind database. I'll add some more logic to this, so that if something goes awry, it will alert me.</p>","fields":{"slug":"/2010/06/flock/"},"frontmatter":{"title":"flock","date":"June 18th, 2010","tags":"shell"}}},"pageContext":{"slug":"/2010/06/flock/"}}}