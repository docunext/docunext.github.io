{"componentChunkName":"component---src-templates-blog-post-js","path":"/2009/12/datamapper-hook-loop-traps/","result":{"data":{"markdownRemark":{"html":"<p>Long story made short: I can't definte a save hook with one class that involves another object getting saved, because it triggers the same hook again.</p>\n<pre class=\"sh_sh\">\n!! Unexpected error while processing request: stack level too deep\n</pre>\n<p>Doh!</p>\n<p>Then I tried redefining the save method:</p>\n<pre class=\"sh_ruby\">\n  def save\n    myaccount = self.account\n    myaccount.cached_journal_balance = myaccount.journal_balance\n    self.myaccount.save\n    super\n  end\n</pre>\n<p>No go:</p>\n<pre>\n>> Listening on 0.0.0.0:3000, CTRL+C to stop\n!! Unexpected error while processing request: wrong number of arguments (1 for 0)\n</pre>\n<p>Grrrr... I believe part of the problem is that the class I'm trying to work with is inherited by a couple others.</p>\n<p>It looks like I might have been able to get away with this lame-o instance variable on a parent object:</p>\n<pre class=\"sh_ruby\">\n  after :save, :account_balances\n  before :save, :unsaved\n  def unsaved\n    entry = self.entry\n    if entry.saved == nil\n      entry.saved = 0\n    end\n  end\n  def account_balances\n    entry = self.entry\n    if entry.saved == 0\n      entry.saved = 1\n      account = Account.get(account_id)\n      puts account.id\n      mybal = account.journal_balance\n      puts mybal\n      account.cached_journal_balance = mybal\n      account.save\n    end\n  end\n</pre>\n<p>I'm not exactly sure why its working (and I don't think its working extremely well), but so far so good.</p>\n<p>Related:</p>\n<ul>\n<li><a href=\"http://datamapper.org/docs/callbacks.html\">http://datamapper.org/docs/callbacks.html</a></li>\n<li><a href=\"http://www.mail-archive.com/datamapper@googlegroups.com/msg01224.html\">http://www.mail-archive.com/datamapper@googlegroups.com/msg01224.html</a></li>\n<li><a href=\"http://www.andrewbuntine.com/articles/about/merb\">http://www.andrewbuntine.com/articles/about/merb</a></li>\n</ul>\n<p>Â¥</p>","frontmatter":{"title":"DataMapper Hook Loop Traps","date":"December 7th, 2009"}}},"pageContext":{"slug":"/2009/12/datamapper-hook-loop-traps/"}}}