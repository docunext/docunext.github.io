{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/2009/12/varnish-grace-without-polling/",
    "result": {"data":{"site":{"siteMetadata":{"domain":"https://www.docunext.com"}},"markdownRemark":{"html":"<p>I finally managed to setup grace on Varnish so that it works when a backend server goes down AND when the backend does not have polling setup.</p>\n<p>I think it does require polling to be setup on a fake server though. I got the idea from <a href=\"http://projects.linpro.no/pipermail/varnish-misc/2009-May/002805.html\">Alex Mizrahi's email to the Linpro Varnish mailing list</a>:</p>\n<blockquote>\nserving stale content during grace period works fine if backend polling can\ndetect that server is down. however in some cases polling thinks that server\nis fine, but it returns 50x error for some requests (e.g. when database\nserver is overloaded), and it might be better if stale content would be\nserved. (by the way, that's how grace works in nginx web server's cache.)\n<p>as i understand, varnish does not support this case now.\nnevertheless, i've tried to hack something with vcl, using example with\nrestarts as inspiration. i've made a nonexistant backend for this purposes,\nwith polling enabled:</p>\n<pre>\nbackend nonexistant {\n        .host = \"localhost\";\n        .port = \"31337\";\n        .probe = {\n           .interval = 10s;\n           .timeout = 0.3 s;\n           .window = 2;\n           .threshold = 1;\n        }\n}\n</pre>\n<p>then it vcl_fetch, when it sees status 500, it\ncalls restart:</p>\n<pre>\nsub vcl_fetch {\n        if (obj.status == 500) {\n                restart;\n        }\n}\n</pre>\n<p>and vcl_recv sets backend to nonexistant in case of restart:</p>\n<pre>\nsub vcl_recv {\n        if (req.restarts == 0) {\n                set req.grace = 2m;\n                set req.backend = apache;\n        } else {\n                set req.grace = 2m;\n                set req.backend = nonexistant;\n        }\n}\n</pre>\n</blockquote>\n<p>Except on my server, when Varnish would try to fetch, the missing backend would send it right to error, and it would never get the chance to restart, resulting in a 503 response (yes, I tried changing the 500 in the example to 503).</p>\n<p>I tried putting the restart block in my VCL error code, but no luck. Varnish reported an error. I did some digging on the idea of putting restart into the error vcl and learned that the functionality was added this past year. I upgraded my varnish version to 2.0.5 and it now works. Rock on!</p>\n<p>This is what I use in the sub vcl_error block:</p>\n<pre>\n    if(req.restarts < 1) {\n        restart;\n    }\n</pre>\n<p>Hopefully I won't get too many errors, but regardless of what causes the error, Varnish will try one more time before it gives up.</p>","fields":{"slug":"/2009/12/varnish-grace-without-polling/"},"frontmatter":{"title":"Varnish Grace Without Polling","date":"December 21st, 2009","tags":"caching,varnish"}}},"pageContext":{"slug":"/2009/12/varnish-grace-without-polling/"}},
    "staticQueryHashes": ["3159585216","758480095"]}