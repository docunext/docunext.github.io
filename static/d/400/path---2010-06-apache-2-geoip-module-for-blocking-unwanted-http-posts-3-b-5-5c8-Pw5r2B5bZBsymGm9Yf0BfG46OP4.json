{"data":{"markdownRemark":{"html":"<p>For some time I've used <a href=\"http://www.docunext.com/wiki/Mod_spamhaus\">mod_spamhaus</a> to block comment spam, similar to how I deflect email spam. I'm OK with this because it only blocks POST, PUT, DELETE, and CONNECT requests, not GET requests.</p>\n<p>Still, email spam is different than comment spam, so I setup mod_geoip to block users from anonymous proxies (that's the \"A1\" in the rewrite rule below). I'm also tracking countries codes in the logs to see if I can find out where most of the POSTs are coming from.</p>\n<h4>GeoIP Module Setup</h4>\n<pre class=\"sh_xml\">\n&lt;IfModule mod_geoip.c&gt;\n  GeoIPEnable On\n  GeoIPDBFile /usr/share/GeoIP/GeoIP.dat MMapCache\n  GeoIPOutput All\n  GeoIPScanProxyHeaders On\n&lt;/IfModule&gt;\n</pre>\n<h4>Access Control</h4>\n<pre class=\"sh_sh\">\nRewriteCond %{REQUEST_METHOD} POST\nRewriteCond %{ENV:GEOIP_COUNTRY_CODE} ^(A1)$\nRewriteRule . - [F,L]\n</pre>\n<h4><strong>Logs</strong></h4>\n<pre class=\"sh_sh\">\nLogFormat \"\\\"%{X-FORWARDED-FOR}i\\\" \\\"%{PROXY-CONNECTION}i\\\" \\\"%{HTTP-PC-REMOTE-ADDR}i\\\" \\\"%{GEOIP_COUNTRY_CODE}e\\\" \\\"%r\\\"\" proxy_info\n</pre>\n<h4><strong>NGINX Too!</strong></h4>\n<p>What's extra cool is that NGINX has this capability too! Its even built into the latest debian package:</p>\n<pre class=\"sh_sh\">\n    ./configure --conf-path=/etc/nginx/nginx.conf \\\n        --error-log-path=/var/log/nginx/error.log \\\n        --pid-path=/var/run/nginx.pid \\\n        --lock-path=/var/lock/nginx.lock \\\n        --http-log-path=/var/log/nginx/access.log \\\n        --http-client-body-temp-path=/var/lib/nginx/body \\\n        --http-proxy-temp-path=/var/lib/nginx/proxy \\\n        --http-fastcgi-temp-path=/var/lib/nginx/fastcgi \\\n        --with-debug \\\n        --with-http_stub_status_module \\\n        --with-http_flv_module \\\n        --with-http_ssl_module \\\n        --with-http_dav_module \\\n        --with-http_gzip_static_module \\\n        --with-http_realip_module \\\n        --with-mail \\\n        --with-mail_ssl_module \\\n        --with-ipv6 \\\n        --with-http_geoip_module \\\n        --add-module=$(CURDIR)/modules/nginx-upstream-fair\n</pre>\n<p>Oh cool - it has the static gzip module too!</p>","frontmatter":{"title":"Apache2 GeoIP Module For Blocking Unwanted HTTP POSTs","date":"June 13th, 2010"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/2010/06/apache2-geoip-module-for-blocking-unwanted-http-posts/"}}