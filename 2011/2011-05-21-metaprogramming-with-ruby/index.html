<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:87.5%/1.714 'Open Sans',sans-serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.73);font-family:'Open Sans',sans-serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.714rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.714rem;color:inherit;font-family:'Open Sans',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1.6rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.714rem;color:inherit;font-family:'Open Sans',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1.32578rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.714rem;color:inherit;font-family:'Open Sans',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1.20684rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.714rem;color:inherit;font-family:'Open Sans',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.714rem;color:inherit;font-family:'Open Sans',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:0.91028rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.714rem;color:inherit;font-family:'Open Sans',sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:0.86849rem;line-height:1.1;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.714rem;}ul{margin-left:1.714rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.714rem;list-style-position:outside;list-style-image:none;list-style:disc outside;}ol{margin-left:1.714rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.714rem;list-style-position:outside;list-style-image:none;list-style:decimal outside;}dl{margin-left:1.714rem;margin-right:1.714rem;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.714rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.714rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.714rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.714rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.714rem;font-size:0.85rem;line-height:1.42;background:hsla(0,0%,0%,0.04);border-radius:3px;overflow:auto;word-wrap:normal;padding:1.714rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.714rem;font-size:0.91028rem;line-height:1.714rem;border-collapse:collapse;width:100%;color:hsla(0,0%,0%,0.54);}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.714rem;}blockquote{margin-left:1.714rem;margin-right:1.714rem;margin-top:0;padding-bottom:1.714rem;padding-left:1.714rem;padding-right:1.714rem;padding-top:1.714rem;margin-bottom:1.714rem;font-style:italic;}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.714rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.714rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.714rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.714rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.714rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;text-transform:uppercase;color:hsla(0,0%,0%,0.61);}li{margin-bottom:calc(1.714rem / 2);margin-left:2.571rem;}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.714rem;margin-bottom:calc(1.714rem / 2);margin-top:calc(1.714rem / 2);}li > ul{margin-left:1.714rem;margin-bottom:calc(1.714rem / 2);margin-top:calc(1.714rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.714rem / 2);}code{font-size:0.85rem;line-height:1.714rem;}kbd{font-size:0.85rem;line-height:1.714rem;}samp{font-size:0.85rem;line-height:1.714rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.14267rem;padding-right:1.14267rem;padding-top:0.857rem;padding-bottom:calc(0.857rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}tt,code{background-color:hsla(0,0%,0%,0.04);border-radius:3px;font-family:"SFMono-Regular", Consolas,"Roboto Mono","Droid Sans Mono","Liberation Mono",Menlo,Courier,monospace;padding:0;padding-top:0.2em;padding-bottom:0.2em;}pre code{background:none;line-height:1.42;}code:before,code:after,tt:before,tt:after{letter-spacing:-0.2em;content:"Â ";}pre code:before,pre code:after,pre tt:before,pre tt:after{content:none;}ol,ul{margin-left:0;}a{color:#21759b;}a:hover{color:#0f3647;}a:visited{color:#9f9f9f;}</style><meta name="generator" content="Gatsby 2.4.2"/><title data-react-helmet="true">Metaprogramming with Ruby method missing and define method</title><link href="//fonts.googleapis.com/css?family=Open+Sans:400,400i,700" rel="stylesheet" type="text/css"/><link as="script" rel="preload" href="/1-dd7c0a064660cc51b5d6.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-fa43ce5e61c19e65ef7c.js"/><link as="script" rel="preload" href="/0-03d194fc431facdf311b.js"/><link as="script" rel="preload" href="/app-b3a037db3f0513c90691.js"/><link as="script" rel="preload" href="/webpack-runtime-d9a47821c1addf3ec063.js"/><link as="fetch" rel="preload" href="/static/d/166/path---2011-2011-05-21-metaprogramming-with-ruby-702-4a2-hSEqzgnqpdJntKiAnsAlaQ6RXWI.json" crossorigin="use-credentials"/></head><body><noscript id="gatsby-noscript">This app works best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><style data-emotion-css="1ycjowu">.css-1ycjowu{margin:0 auto;max-width:700px;padding:3.428rem;padding-top:2.571rem;}</style><div class="css-1ycjowu"><header style="margin-bottom:1.5rem"><a href="/"><style data-emotion-css="14036a">.css-14036a{margin-top:0;margin-bottom:1.714rem;display:inline-block;font-style:normal;}</style><h1 class="css-14036a">Docunext</h1></a><ul style="list-style:none;float:right"><style data-emotion-css="146q31f">.css-146q31f{float:right;}</style><li style="display:inline-block;margin-right:1rem"><a href="/about/">About</a></li></ul></header><hr/><div><h2>Metaprogramming with Ruby method missing and define method</h2><div><p>There are many reasons why I love working with Ruby, such as its consistency, its use of natural language, its clean object-oriented paradigm, but one aspect of it is that stands out above the rest: its metaprogramming capabilities.</p>
<h4>What is "Metaprogramming"?</h4>
<p>Metaprogramming is the practice of writing code that generates more code, and then running that code in the same process.</p>
<p>Seen from another angle, it is the practice of writing code that modifies or adds to itself as it runs. As such, in my humble opinion, its a heck of a lot easier to do with an scripting / interpreted language like Ruby than a compiled language like C.</p>
<p>Metaprogramming is also related to domain specific languages. In the case of Ruby, Rake and Sinatra are domain specific languages.</p>
<h4>Examples of Metaprogramming</h4>
<p>There are many different paths to and styles of metaprogramming in other languages; in Ruby, there are built-in hooks to help software engineers build software which will eventually make themselves obsolete! (Just a little humor there for you... or not?) The hooks are method_missing and define_method.</p>
<p>On their own, they are quite useful tools. Together, they are a powerful combo that are filled me with awe of Ruby - we'll touch on that later. First, what are they and what do they do. (Side note: "Who is your daddy,  and what does he do?" - Anyone? Anyone?)</p>
<h4>method_missing</h4>
<p>If you've ever had a typo in a method call, you've likely encountered method_missing. It is called when a non-existent method is called, and its included as part of Ruby's Kernel class<span class="sup">1</span>.</p>
<p>The general practice is to override method_missing, and do something besides raising an exception. So let's get to an example, shall we?</p>
<pre class="sh_ruby">
class Foo
  def method_missing(m, *args, &block)
    if m.to_s.include? 'bar'
      puts "SNAFU"
    else
      super
    end
  end
end
yo = Foo.new
yo.foobar
yo.snafu
</pre>
<p>I've employed some standard best-practices with this example, so it isn't the simplest case, but fear not oh loyal reader, I shall explain what's going down.</p>
<p>First off, method_missing can take three arguments, and I've included them here. It requires the first one, which is the name of the missing method that is getting called. The next two are the arguments and / or the block that are getting passed to the method.</p>
<p>After that, there is a test to check whether the method name includes "bar". Why? This is a technique to ensure that non-existent methods that really should not exist are not handled. Why? So that bugs like typos can be identified. If you take a moment to ponder, you might agree that's its generally not a good idea to try and generate code for every potential method name in existence!</p>
<p>If the calling method's name does include the string "bar", we'll put "SNAFU", if not, we let the standard method_missing method handle it (and raise an exception). If I run this code, that's exactly what will happen:</p>
<pre class="sh_terminal">
?> yo = Foo.new
=> #<Foo:0xb74836c4>
>> yo.foobar
SNAFU
=> nil
>> yo.snafu
NoMethodError: undefined method `snafu' for #<Foo:0xb74836c4>
	from (irb):7:in `method_missing'
	from (irb):15
</pre>
<p>Yay! We're already metaprogramming. What happened? When yo called foobar, yo could not find a method with its name, so its version of method_missing created a temporary one on the fly. Cool, huh?</p>
<h4>define_method</h4>
<p>In my humble opinion, define_method is where things really get exciting, because when combined with method_missing, it is possible to start really building code during runtime.</p>
<p>The define_method method is found in the <a href="http://ruby-doc.org/core/classes/Module.html#M000497">Module class</a>. It is private class method, so it is called on its parent object, not on instances.</p>
<p>First let's take a look at what define_method can do. Examine these two classes:</p>
<pre class="sh_ruby">
class Foo
  def snafu
    puts "hi"
  end
end
class Bar
  define_method(:snafu) do
    puts "hi"
  end
end
</pre>
<p>In essence, they are identical. So why would we ever want to use something like define_method? Its often used with arrays, like this:</p>
<pre class="sh_ruby">
module Stuff
  MYKEYS = ['date','betterdate']
  MYHASH = {
          't1' => {'date' => '2000', 'betterdate' => '2000', 'dynamicdate' => '2000' },
          't2' => Hash.new('2011')
        }
end
class Test
  include Stuff
  MYKEYS.each do |k|
    define_method(k.to_sym) do |myid|
      MYHASH[myid][k]
    end
  end
end
</pre>
<p>In that example, we're creating methods to access values from a hash. This example is futile; hopefully it illustrates how define_method could be used on its own. Handy, right? Not really earth shattering though... what gives? Its limited by the fact that it is a private class method that creates class methods when its class is defined. In other words, it cannot be called directly during runtime making it a heck of a lot less dynamic than method_missing. Can you tell the difference? Good! Now let's talk about the magical combo.</p>
<h4>A Match Made of Rubies: method_missing and define_method</h4>
<p>I employ no hyperbole - this is where the magic happens.</p>
<p>Remember that the problem with method_missing is that it is a private class method, and can't be directly called from an instance at runtime. Is there another way??? <strong>Yes!</strong> Here comes method_missing to the rescue.</p>
<p>I'll jump right into an example:</p>
<pre class="sh_ruby">
  def method_missing(m, *args, &block)
    if ALLKEYS.include?(m.to_s)
      # Yes, smarter key
      self.class.send(:define_method, m) do
        MYHASH[name][m.to_s]
      end
      self.send(m)
    else
      super
    end
  end
</pre>
<p>Like the first example of method_missing, I've again employed some standard best-practices to use with method_missing, like the string inclusion check, and the alternate push to super, the rest is much different - what's going on with all the sends?</p>
<p>With method_missing, we can tell an instance to ask its parent class to call upon one of its class methods, specifically define_method: <tt>self.class.send(:define_method, m) do</tt>. In doing so, we can pass it the non-existent method's name, and whatever the non-existent method is passed. After that, we can actually call the method as an instance method. Sufferin' succotash! That is inconceivable!</p>
<p>Savvy readers might be wondering:</p>
<blockquote class="svxlb"><pre>
What's the advantage of doing it this way as opposed to simply using method_missing by itself?
</pre></blockquote>
<p>There is a very good reason for using define_method inside of method_missing:
performance. Let me elaborate.</p>
<p>Software engineering often involves patterns that slightly or substantially
differ from one another, and sometimes those patterns are programmatic. As such,
software engineers can write algorithms to identify and specify those patterns,
saving themselves immeasurable time having to manually write code that consists
of mostly repetitive logic that slightly differs here and there.</p>
<p>The problem with employing that method at compile time (or in the case of Ruby,
upon instantiation), is that it can take a long time to iterate through all the
possible pattern changes and generate code to support it - an issue exacerbated
by the likelihood that not all of the pattern differences are significant and
will never be used. So why not create a method to catch those patterns during
runtime and define real methods to handle them if and when they next needed?
I can't think of a reason, so let's do so. This practice is often referred to as
lazy loading, and in my humble opinion, its a <em>very</em> cool way to work.</p>
<p>Other engineers agree - ORM tools like ActiveRecord and DataMapper use lazy
loading to dynamically generate methods for object properties based upon
characteristics of the data sets. If they created all those methods up front, it
would take a much longer for Ruby applications to use them, and if they only
used method_missing, they would not be optimizing when they could.</p>
<p>I'd love to hear your thoughts about Metaprogramming with Ruby, or this post.
See any typos or areas of improvement? Use the comment form below to sound off.</p>
<h4>See Also</h4>
<ul>
<li><a href="http://www.docunext.com/wiki/ruby/ruby-metaprogramming.html">Metaprogramming with Ruby</a></li>
</ul>
<h4>Footnotes</h4>
<ul>
<li><span class="sup">1</span> - While I was checking on that, I noticed that it is not included in the <a href="http://www.ruby-doc.org/core/classes/Kernel.html">Ruby 1.9.2 API documentation for the Kernel class</a>, though it is of course included in <a href="http://www.ruby-doc.org/core-1.8.7/classes/Kernel.html#M001069">1.8.7</a>. Does anyone know what's up with that?</li>
</ul></div></div></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-blog-post-js","jsonName":"2011-2011-05-21-metaprogramming-with-ruby-702","path":"/2011/2011-05-21-metaprogramming-with-ruby/"};window.dataPath="166/path---2011-2011-05-21-metaprogramming-with-ruby-702-4a2-hSEqzgnqpdJntKiAnsAlaQ6RXWI";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-b3a037db3f0513c90691.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-fa43ce5e61c19e65ef7c.js"],"component---src-pages-about-js":["/component---src-pages-about-js-bc02bbc13e5fe52afb57.js"],"component---src-pages-index-js":["/component---src-pages-index-js-6bac0da1b67b4ccf4d11.js"],"component---src-pages-my-files-js":["/component---src-pages-my-files-js-4ca90275b4e81ff0a8db.js"],"pages-manifest":["/pages-manifest-5d6198a3ec9441e707f7.js"]};/*]]>*/</script><script src="/webpack-runtime-d9a47821c1addf3ec063.js" async=""></script><script src="/app-b3a037db3f0513c90691.js" async=""></script><script src="/0-03d194fc431facdf311b.js" async=""></script><script src="/component---src-templates-blog-post-js-fa43ce5e61c19e65ef7c.js" async=""></script><script src="/1-dd7c0a064660cc51b5d6.js" async=""></script></body></html>